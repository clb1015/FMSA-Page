<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>FMSA - Florida Music Supervision Association</title>
    
    <!-- Tailwind CSS -->
    <script src="https://cdn.tailwindcss.com"></script>
    
    <!-- Leaflet CSS -->
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/leaflet/1.9.4/leaflet.css" />
    
    <!-- Leaflet JS -->
    <script src="https://cdnjs.cloudflare.com/ajax/libs/leaflet/1.9.4/leaflet.js"></script>

    <!-- TopoJSON Client -->
    <script src="https://cdnjs.cloudflare.com/ajax/libs/topojson/3.0.2/topojson.min.js"></script>

    <!-- Font Awesome for Icons -->
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.4.0/css/all.min.css">

    <style>
        /* Custom Styles */
        #map {
            height: 600px;
            width: 100%;
            z-index: 1;
            background-color: #e5e7eb; /* Light gray background to show map frame */
        }
        
        .leaflet-popup-content-wrapper {
            border-radius: 0.5rem;
            box-shadow: 0 10px 15px -3px rgba(0, 0, 0, 0.1), 0 4px 6px -2px rgba(0, 0, 0, 0.05);
        }

        .leaflet-popup-content {
            margin: 0;
            line-height: 1.5;
        }

        /* Custom Scrollbar */
        .custom-scrollbar::-webkit-scrollbar {
            width: 8px;
        }
        .custom-scrollbar::-webkit-scrollbar-track {
            background: #f1f1f1;
        }
        .custom-scrollbar::-webkit-scrollbar-thumb {
            background: #888;
            border-radius: 4px;
        }
        .custom-scrollbar::-webkit-scrollbar-thumb:hover {
            background: #555;
        }

        /* Mobile Adjustments */
        @media (max-width: 640px) {
            #map {
                height: 400px;
            }
        }
    </style>
</head>
<body class="bg-gray-50 text-gray-800 font-sans">

    <!-- Header Section -->
    <header class="bg-blue-900 text-white shadow-lg">
        <div class="container mx-auto px-4 py-6">
            <div class="flex flex-col md:flex-row justify-between items-center">
                <div class="mb-4 md:mb-0">
                    <h1 class="text-2xl md:text-3xl font-bold flex items-center gap-3">
                        <i class="fa-solid fa-music text-yellow-400"></i>
                        FMSA Directory
                    </h1>
                    <p class="text-blue-200 mt-1">Florida Music Supervision Association</p>
                </div>
                
                <!-- Search Box -->
                <div class="relative w-full md:w-96">
                    <div class="absolute inset-y-0 left-0 pl-3 flex items-center pointer-events-none">
                        <i class="fa-solid fa-search text-gray-400"></i>
                    </div>
                    <input type="text" id="countySearch" 
                        class="block w-full pl-10 pr-3 py-2 border border-transparent rounded-lg leading-5 bg-blue-800 text-white placeholder-blue-300 focus:outline-none focus:bg-white focus:text-gray-900 focus:ring-2 focus:ring-yellow-400 transition duration-150 ease-in-out" 
                        placeholder="Find your county..." autocomplete="off">
                    <div id="searchResults" class="absolute z-50 mt-1 w-full bg-white shadow-xl rounded-md overflow-hidden hidden">
                        <!-- Search results will populate here -->
                    </div>
                </div>
            </div>
        </div>
    </header>

    <!-- Main Content -->
    <main class="container mx-auto px-4 py-8">
        
        <!-- Interactive Map Section -->
        <div class="bg-white rounded-xl shadow-md overflow-hidden mb-10 border border-gray-200">
            <div class="p-4 bg-gray-100 border-b border-gray-200 flex justify-between items-center flex-wrap gap-2">
                <h2 class="font-semibold text-lg text-gray-700">Interactive County Map</h2>
                <div class="flex gap-4 text-sm">
                    <div class="flex items-center gap-1"><span class="w-3 h-3 rounded-full bg-blue-600 block shadow-sm border border-blue-700"></span> Active Supervisor</div>
                    <div class="flex items-center gap-1"><span class="w-3 h-3 rounded-full bg-gray-400 block shadow-sm border border-gray-500"></span> No Data/Inactive</div>
                </div>
            </div>
            <div class="relative">
                <div id="map"></div>
                
                <!-- Loading Indicator -->
                <div id="map-loading" class="absolute inset-0 bg-gray-100/90 z-[500] flex items-center justify-center backdrop-blur-sm">
                    <div class="text-center">
                        <i class="fa-solid fa-circle-notch fa-spin text-4xl text-blue-600 mb-2"></i>
                        <p class="text-gray-600 font-medium mt-2">Loading Map Data...</p>
                    </div>
                </div>

                <!-- Mobile overlay hint -->
                <div id="map-hint" class="absolute inset-0 bg-black/50 z-[1000] flex items-center justify-center pointer-events-none opacity-0 transition-opacity duration-300 md:hidden">
                    <span class="text-white font-bold text-lg bg-black/70 px-4 py-2 rounded">Use two fingers to pan</span>
                </div>
            </div>
        </div>

        <!-- Directory List Section -->
        <div class="bg-white rounded-xl shadow-md overflow-hidden border border-gray-200">
            <div class="p-6 border-b border-gray-200 bg-gray-50">
                <h2 class="text-xl font-bold text-gray-800">Supervisor Directory</h2>
                <p class="text-sm text-gray-500 mt-1">Contact information for active music supervisors.</p>
            </div>
            
            <div class="overflow-x-auto">
                <table class="min-w-full divide-y divide-gray-200">
                    <thead class="bg-gray-50">
                        <tr>
                            <th scope="col" class="px-6 py-3 text-left text-xs font-medium text-gray-500 uppercase tracking-wider">County</th>
                            <th scope="col" class="px-6 py-3 text-left text-xs font-medium text-gray-500 uppercase tracking-wider">Supervisor</th>
                            <th scope="col" class="px-6 py-3 text-left text-xs font-medium text-gray-500 uppercase tracking-wider">Contact</th>
                        </tr>
                    </thead>
                    <tbody id="directoryTable" class="bg-white divide-y divide-gray-200">
                        <!-- Table rows will be populated by JS -->
                    </tbody>
                </table>
            </div>
        </div>
        
        <!-- General Contact / Fallback Info -->
        <div class="mt-8 p-6 bg-blue-50 rounded-xl border border-blue-100 flex items-start gap-4">
            <div class="bg-blue-100 p-3 rounded-full text-blue-600 shrink-0">
                <i class="fa-solid fa-circle-info text-xl"></i>
            </div>
            <div>
                <h3 class="font-bold text-blue-900">Information Not Listed?</h3>
                <p class="text-blue-800 mt-1 text-sm">
                    If a county does not have a supervisor listed, please feel free to reach out to a local county representative or 
                    <strong>Dr. Christopher Burns</strong>, Osceola County Music Supervisor.
                </p>
                <div class="mt-3">
                    <a href="mailto:christopher.burns@osceolaschools.net?subject=FMSA%20Inquiry" class="inline-flex items-center gap-2 text-sm font-semibold text-blue-700 hover:text-blue-900 bg-white px-4 py-2 rounded-md shadow-sm border border-blue-200 transition-colors">
                        <i class="fa-solid fa-envelope"></i> Email Dr. Burns
                    </a>
                </div>
            </div>
        </div>

    </main>

    <footer class="bg-gray-800 text-gray-400 py-8 mt-12">
        <div class="container mx-auto px-4 text-center">
            <p>&copy; 2025 Florida Music Supervision Association. All rights reserved.</p>
        </div>
    </footer>

    <script>
        // --- DATA SECTION ---
        const supervisorData = [
            { county: "Alachua", first: "Diana", last: "Rollo", email: "Rollod@gm.sbac.edu", phone: "", active: true },
            { county: "Baker", first: "", last: "", email: "", phone: "", active: false, website: "https://www.bakerk12.org" },
            { county: "Bay", first: "Josh", last: "Laatsch", email: "laatsj@bay.k12.fl.us", phone: "", active: true },
            { county: "Bradford", first: "", last: "", email: "", phone: "", active: false, website: "https://www.bradford.k12.fl.us" },
            { county: "Brevard", first: "Minnie", last: "Orr", email: "Orr.Minnie@brevardschools.org", phone: "", active: true },
            { county: "Broward", first: "Joe", last: "Luechauer", email: "joeluechauer@browardschools.com", phone: "", active: true },
            { county: "Calhoun", first: "", last: "", email: "", phone: "", active: false, website: "https://www.calhounflschools.org" },
            { county: "Charlotte", first: "Ellen", last: "Harvey", email: "Ellen.Harvey@yourcharlotteschools.net", phone: "", active: true }, 
            { county: "Clay", first: "Christopher", last: "Gugel", email: "christopher.gugel@myoneclay.net", phone: "", active: true },
            { county: "Collier", first: "Skip (Harry)", last: "Pardee", email: "pardeh@collierschools.com", phone: "", active: true },
            { county: "Duval", first: "Laurie", last: "Hoppock", email: "HoppockL@duvalschools.org", phone: "", active: true },
            { county: "Escambia", first: "Barbie", last: "Spears", email: "bspears@ecsdfl.us", phone: "", active: true },
            { county: "Hernando", first: "Joe", last: "Harrin", email: "Harrin_j@hcsb.k12.fl.us", phone: "", active: true },
            { county: "Hillsborough", first: "Jon", last: "Sever", email: "Jon.Sever@hcps.net", phone: "", active: true },
            { county: "Lake", first: "Christina", last: "Szuba", email: "szubac@lake.k12.fl.us", phone: "", active: true },
            { county: "Lee", first: "Jason", last: "Thomashefsky", email: "JasonET@LeeSchools.net", phone: "", active: true },
            { county: "Leon", first: "Benny", last: "Bolden", email: "boldenb@leonschools.net", phone: "", active: true },
            { county: "Manatee", first: "Ricardo", last: "Robinson-Shinall", email: "robinsonr@manateeschools.net", phone: "", active: true },
            { county: "Marion", first: "Brooke", last: "Hutto", email: "Brooke.Hutto@marion.k12.fl.us", phone: "", active: true },
            { county: "Miami-Dade", first: "Patricio", last: "Suarez", email: "psuarez@dadeschools.net", phone: "", active: true },
            { county: "Monroe", first: "Gary", last: "Hernandez", email: "gary.hernandez@keysschools.com", phone: "", active: true },
            { county: "Okaloosa", first: "Terry", last: "Schroeder", email: "Teresa.Schroeder@Okaloosaschools.com", phone: "", active: false },
            { county: "Orange", first: "Jason", last: "Locker", email: "jason.locker@ocps.net", phone: "", active: true },
            { county: "Osceola", first: "Chris", last: "Burns", email: "Christopher.Burns@osceolaschools.net", phone: "", active: true },
            { county: "Palm Beach", first: "Cleve", last: "Maloon", email: "cleve.maloon@palmbeachschools.org", phone: "", active: true },
            { county: "Pasco", first: "Thomas", last: "Viking", email: "tviking@pasco.k12.fl.us", phone: "", active: true },
            { county: "Pinellas", first: "Ajori", last: "Spencer", email: "SpencerA@pcsb.org", phone: "", active: true },
            { county: "Polk", first: "Don", last: "West", email: "donald.west@polk-fl.net", phone: "", active: true },
            { county: "Putnam", first: "", last: "", email: "", phone: "", active: false, website: "https://www.putnamschools.org" },
            { county: "St. Johns", first: "Joanne", last: "Crowder", email: "Joanne.Crowder@stjohns.k12.fl.us", phone: "", active: true, website: "https://www.stjohns.k12.fl.us" },
            { county: "St. Lucie", first: "Karen", last: "Crocco", email: "Karen.Crocco@stlucieschools.org", phone: "", active: true, website: "https://www.stlucie.k12.fl.us" },
            { county: "Santa Rosa", first: "Alicia", last: "Coon", email: "CoonA@santarosa.k12.fl.us", phone: "", active: true, website: "https://www.santarosa.k12.fl.us" },
            { county: "Sarasota", first: "Angela", last: "Hartvigsen", email: "Angela.Hartvigsen@sarasotacountyschools.net", phone: "941-927-9000", active: true },
            { county: "Seminole", first: "Lindsey", last: "Williams", email: "Lindsey_Williams@scps.k12.fl.us", phone: "", active: true },
            { county: "Sumter", first: "", last: "", email: "", phone: "", active: false, website: "https://www.sumter.k12.fl.us" },
            { county: "Volusia", first: "John", last: "DuPuis", email: "jjdupuis@volusia.k12.fl.us", phone: "386-734-7190", active: true },
            { county: "Walton", first: "Jaime", last: "Mitchell", email: "mitchellj@walton.k12.fl.us", phone: "", active: true }
        ];

        // --- MAP INITIALIZATION ---

        const map = L.map('map', {
            center: [28.2, -83.5], 
            zoom: 7,
            scrollWheelZoom: false,
            dragging: !L.Browser.mobile,
            tap: !L.Browser.mobile
        });

        // Using standard OSM tiles
        L.tileLayer('https://{s}.tile.openstreetmap.org/{z}/{x}/{y}.png', {
            attribution: '&copy; <a href="https://www.openstreetmap.org/copyright">OpenStreetMap</a> contributors',
            maxZoom: 19
        }).addTo(map);

        // Mobile Handlers
        if (L.Browser.mobile) {
            map.dragging.disable();
            const mapContainer = document.getElementById('map');
            const hintOverlay = document.getElementById('map-hint');
            
            mapContainer.addEventListener('touchstart', (e) => {
                if (e.touches.length === 1) {
                    hintOverlay.classList.remove('opacity-0');
                    setTimeout(() => hintOverlay.classList.add('opacity-0'), 1500);
                }
            });

            mapContainer.addEventListener('touchmove', (e) => {
                if (e.touches.length >= 2) {
                    map.dragging.enable();
                } else {
                    map.dragging.disable();
                }
            });
        }

        let geojsonLayer;
        const countyLayers = {}; 

        // FIPS Lookup Table
        const fipsToCounty = {
            "12001": "Alachua", "12003": "Baker", "12005": "Bay", "12007": "Bradford", "12009": "Brevard",
            "12011": "Broward", "12013": "Calhoun", "12015": "Charlotte", "12017": "Citrus", "12019": "Clay",
            "12021": "Collier", "12023": "Columbia", "12027": "DeSoto", "12029": "Dixie", "12031": "Duval",
            "12033": "Escambia", "12035": "Flagler", "12037": "Franklin", "12039": "Gadsden", "12041": "Gilchrist",
            "12043": "Glades", "12045": "Gulf", "12047": "Hamilton", "12049": "Hardee", "12051": "Hendry",
            "12053": "Hernando", "12055": "Highlands", "12057": "Hillsborough", "12059": "Holmes", "12061": "Indian River",
            "12063": "Jackson", "12065": "Jefferson", "12067": "Lafayette", "12069": "Lake", "12071": "Lee",
            "12073": "Leon", "12075": "Levy", "12077": "Liberty", "12079": "Madison", "12081": "Manatee",
            "12083": "Marion", "12085": "Martin", "12086": "Miami-Dade", "12087": "Monroe", "12089": "Nassau",
            "12091": "Okaloosa", "12093": "Okeechobee", "12095": "Orange", "12097": "Osceola", "12099": "Palm Beach",
            "12101": "Pasco", "12103": "Pinellas", "12105": "Polk", "12107": "Putnam", "12109": "St. Johns",
            "12111": "St. Lucie", "12113": "Santa Rosa", "12115": "Sarasota", "12117": "Seminole", "12119": "Sumter",
            "12121": "Suwannee", "12123": "Taylor", "12125": "Union", "12127": "Volusia", "12129": "Wakulla",
            "12131": "Walton", "12133": "Washington"
        };
        
        async function loadMapData() {
            const loadingDiv = document.getElementById('map-loading');
            
            // Fetch US Atlas Data (County borders)
            const usAtlasUrl = 'https://cdn.jsdelivr.net/npm/us-atlas@3/counties-10m.json';

            try {
                const response = await fetch(usAtlasUrl);
                if (!response.ok) throw new Error(`Data source error: ${response.status}`);
                const topoData = await response.json();
                
                if (window.topojson) {
                    const geoData = topojson.feature(topoData, topoData.objects.counties);
                    
                    // Filter for Florida (FIPS starts with '12')
                    geoData.features = geoData.features.filter(feature => {
                        const idStr = String(feature.id);
                        return idStr.startsWith('12');
                    });

                    // Add names based on FIPS
                    geoData.features.forEach(feature => {
                        const idStr = String(feature.id);
                        if (fipsToCounty[idStr]) {
                            feature.properties.name = fipsToCounty[idStr];
                        } else {
                            feature.properties.name = "Unknown";
                        }
                    });

                    renderMap(geoData);
                    loadingDiv.style.display = 'none';
                } else {
                    throw new Error('TopoJSON library not loaded');
                }
                
            } catch (err) {
                console.error("Map error:", err);
                loadingDiv.innerHTML = `
                    <div class="text-center text-red-500 p-4 bg-white rounded shadow-lg border border-red-200">
                        <p class="font-bold">Map Data Unavailable</p>
                        <button onclick="location.reload()" class="mt-2 px-4 py-2 bg-blue-600 text-white rounded text-sm">Retry</button>
                    </div>
                `;
            }
        }

        function renderMap(data) {
            if (geojsonLayer) {
                map.removeLayer(geojsonLayer);
            }
            geojsonLayer = L.geoJson(data, {
                style: styleCounty,
                onEachFeature: onEachFeature
            }).addTo(map);
            
            map.fitBounds(geojsonLayer.getBounds());
        }

        loadMapData();

        function styleCounty(feature) {
            const countyName = feature.properties.name || "Unknown";
            const cleanName = countyName.replace(" County", "");
            
            const supervisor = findSupervisor(cleanName);

            // Active = Blue, Inactive = Gray
            const isActive = supervisor && supervisor.active;

            return {
                fillColor: isActive ? '#2563EB' : '#9CA3AF', 
                weight: 1.5, // Increased weight for better distinction
                opacity: 1,
                color: 'white',
                dashArray: '',
                fillOpacity: 0.75
            };
        }

        function findSupervisor(countyName) {
            if (!countyName) return null;
            const normalizedMapName = countyName.toLowerCase().trim().replace(/[.\s]/g, '');
            
            return supervisorData.find(s => {
                const normalizedDataName = s.county.toLowerCase().trim().replace(/[.\s]/g, '');
                return normalizedDataName === normalizedMapName;
            });
        }

        function onEachFeature(feature, layer) {
            const countyName = feature.properties.name || "Unknown";
            const cleanName = countyName.replace(" County", "");
            
            if (cleanName !== "Unknown") {
                countyLayers[cleanName.toLowerCase()] = layer;
            }

            layer.on({
                mouseover: highlightFeature,
                mouseout: resetHighlight,
                click: zoomToFeature
            });

            const supervisor = findSupervisor(cleanName);
            const popupContent = createPopupContent(cleanName, supervisor);
            layer.bindPopup(popupContent);
        }

        function highlightFeature(e) {
            const layer = e.target;
            layer.setStyle({
                weight: 3,
                color: '#FBBF24', // Yellow highlight
                fillOpacity: 0.9
            });
            layer.bringToFront();
        }

        function resetHighlight(e) {
            geojsonLayer.resetStyle(e.target);
        }

        function zoomToFeature(e) {
            // "Gentle" Zoom
            map.fitBounds(e.target.getBounds(), { padding: [50, 50], maxZoom: 9 });
            e.target.openPopup();
        }

        function createPopupContent(countyName, supervisor) {
            let html = `<div class="p-2 min-w-[200px]">`;
            html += `<h3 class="font-bold text-lg text-blue-900 mb-2 border-b border-gray-200 pb-1">${countyName} County</h3>`;

            if (supervisor && supervisor.active) {
                html += `<p class="font-semibold text-gray-800">${supervisor.first} ${supervisor.last}</p>`;
                
                if (supervisor.email) {
                    html += `<a href="mailto:${supervisor.email}" class="block mt-2 text-blue-600 hover:text-blue-800 text-sm flex items-center gap-2"><i class="fa-solid fa-envelope"></i> ${supervisor.email}</a>`;
                }
                
                if (supervisor.phone) {
                    html += `<span class="block mt-1 text-gray-600 text-sm flex items-center gap-2"><i class="fa-solid fa-phone"></i> ${supervisor.phone}</span>`;
                }
            } else {
                html += `<p class="text-gray-500 italic text-sm">No Active Supervisor Listed</p>`;
                if (supervisor && supervisor.website) {
                     html += `<a href="${supervisor.website}" target="_blank" class="block mt-2 text-blue-500 text-sm hover:underline">Visit District Website</a>`;
                }
                html += `<hr class="my-2 border-gray-200">`;
                html += `<p class="text-xs text-gray-400">Contact Dr. Burns (Osceola) for inquiries.</p>`;
            }
            html += `</div>`;
            return html;
        }

        // --- SEARCH FUNCTIONALITY ---
        const searchInput = document.getElementById('countySearch');
        const searchResults = document.getElementById('searchResults');

        searchInput.addEventListener('input', function(e) {
            const value = e.target.value.toLowerCase().trim(); // Added trim()
            if (value.length < 2) {
                searchResults.classList.add('hidden');
                return;
            }

            // More robust searching: Check against key names
            const matches = Object.keys(countyLayers).filter(name => 
                name.toLowerCase().includes(value)
            );
            
            searchResults.innerHTML = '';
            if (matches.length > 0) {
                searchResults.classList.remove('hidden');
                matches.forEach(match => {
                    const div = document.createElement('div');
                    div.className = "px-4 py-2 hover:bg-blue-50 cursor-pointer border-b border-gray-100 last:border-0 capitalize text-gray-800"; // Added text color
                    // Ensure the county name is capitalized properly for display
                    const displayName = match.charAt(0).toUpperCase() + match.slice(1);
                    div.innerText = displayName + " County";
                    
                    div.onclick = () => {
                        const layer = countyLayers[match];
                        if (layer) {
                            map.fitBounds(layer.getBounds(), { padding: [50, 50], maxZoom: 9 });
                            layer.openPopup();
                            searchInput.value = '';
                            searchResults.classList.add('hidden');
                        }
                    };
                    searchResults.appendChild(div);
                });
            } else {
                // Optional: Show "No results" if helpful, or just hide
                searchResults.classList.add('hidden');
            }
        });

        document.addEventListener('click', function(e) {
            if (!searchInput.contains(e.target) && !searchResults.contains(e.target)) {
                searchResults.classList.add('hidden');
            }
        });

        // --- DIRECTORY LIST ---
        const tableBody = document.getElementById('directoryTable');
        
        supervisorData.sort((a, b) => a.county.localeCompare(b.county));

        supervisorData.forEach(s => {
            if (!s.active) return;

            const row = document.createElement('tr');
            row.className = "hover:bg-gray-50 transition-colors cursor-pointer"; 
            
            const nameCell = `${s.first} ${s.last}`;
            let contactInfo = '';
            
            if (s.email) contactInfo += `<a href="mailto:${s.email}" onclick="event.stopPropagation()" class="text-blue-600 hover:text-blue-800 mr-3" title="Email"><i class="fa-solid fa-envelope"></i></a>`;
            if (s.phone) contactInfo += `<span class="text-gray-600 cursor-default" title="Phone"><i class="fa-solid fa-phone mr-1"></i> ${s.phone}</span>`;
            if (!contactInfo) contactInfo = `<span class="text-gray-300">-</span>`;

            row.innerHTML = `
                <td class="px-6 py-4 whitespace-nowrap text-sm font-medium text-gray-900">${s.county}</td>
                <td class="px-6 py-4 whitespace-nowrap text-sm text-gray-500">${nameCell}</td>
                <td class="px-6 py-4 whitespace-nowrap text-sm text-gray-500">${contactInfo}</td>
            `;
            
            row.addEventListener('click', () => {
                const cleanName = s.county.toLowerCase();
                if (Object.keys(countyLayers).length === 0) return;
                
                const layer = countyLayers[cleanName];
                if (layer) {
                    window.scrollTo({ top: document.getElementById('map').offsetTop - 100, behavior: 'smooth' });
                    setTimeout(() => {
                        map.fitBounds(layer.getBounds(), { padding: [50, 50], maxZoom: 9 });
                        layer.openPopup();
                    }, 500);
                }
            });

            tableBody.appendChild(row);
        });

    </script>
</body>
</html>
